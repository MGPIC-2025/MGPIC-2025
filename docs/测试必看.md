# åŽç«¯åˆ°å‰ç«¯æ¶ˆæ¯é›†æˆç³»ç»Ÿ

## å¿«é€Ÿæµ‹è¯• ðŸš€

### æ–¹æ³•1ï¼šåœ¨æµ‹è¯•é¢æ¿æµ‹è¯•ï¼ˆæŽ¨èï¼‰

```bash
npm run dev
```

1. æµè§ˆå™¨æ‰“å¼€åŽè·³è¿‡å¼€åœºåŠ¨ç”»
2. ç‚¹å‡»å³ä¸‹è§’ **ðŸ§ª çº¢è‰²æŒ‰é’®**æ‰“å¼€æµ‹è¯•é¢æ¿
3. **é¢„è®¾æµ‹è¯•**ï¼šç‚¹å‡»ä»»æ„æµ‹è¯•æŒ‰é’®æ‰§è¡Œé¢„å®šä¹‰åºåˆ—
4. **è‡ªå®šä¹‰æµ‹è¯•**ï¼šç‚¹å‡»"è‡ªå®šä¹‰æµ‹è¯• â†’"æŒ‰é’®ï¼Œå¯ä»¥è¾“å…¥å‚æ•°ï¼š
   - ç§»åŠ¨å•ä½åˆ°æŒ‡å®šåæ ‡ (ID, X, Z)
   - æ—‹è½¬å•ä½åˆ°æŒ‡å®šæ–¹å‘ (ID, æ–¹å‘)
   - ç§»é™¤æŒ‡å®šIDçš„å•ä½
5. æŒ‰ **F12** æŸ¥çœ‹æŽ§åˆ¶å°è¾“å‡º

**é¢„æœŸè¾“å‡º**ï¼š
```
[TestPanel] æ‰§è¡ŒåŽç«¯æµ‹è¯•: test_sequence
[MessageQueue] æ”¶åˆ°æ¶ˆæ¯: {type_msg: "move_to", ...}
[Handler] move_to id=1, to=[3,3]
```

### æ–¹æ³•2ï¼šåœ¨3Dåœºæ™¯æµ‹è¯•

1. æµè§ˆå™¨æ‰“å¼€åŽè·³è¿‡å¼€åœºåŠ¨ç”»
2. ç‚¹å‡»å³ä¸‹è§’ **ðŸ§ª çº¢è‰²æŒ‰é’®**æ‰“å¼€æµ‹è¯•é¢æ¿
3. ç‚¹å‡» **ðŸŽ® è¿›å…¥3Dåœºæ™¯** æŒ‰é’®
4. è¿›å…¥3Dåœºæ™¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç«‹æ–¹ä½“ï¼ˆè“è‰²=ID:1ï¼Œçº¢è‰²=ID:2ï¼‰
5. å†æ¬¡ç‚¹å‡»å³ä¸‹è§’æµ‹è¯•é¢æ¿æŒ‰é’®æ‰§è¡Œæµ‹è¯•
6. è§‚å¯Ÿç«‹æ–¹ä½“çš„ç§»åŠ¨ã€æ—‹è½¬ã€çŠ¶æ€æŒ‡ç¤ºå™¨ç­‰æ•ˆæžœ

---

## ç³»ç»Ÿæž¶æž„

### æ¶ˆæ¯æµç¨‹

```
åŽç«¯ MoonBit (send.mbt)
    â†“ broadcast
global_msg
    â†“ subscribe
å‰ç«¯ glue.js
    â†“ enqueue
messageQueue
    â†“ process
æ‰§è¡ŒåŠ¨ç”»/UIæ›´æ–°
```

### æ ¸å¿ƒæ–‡ä»¶

**åŽç«¯**ï¼š
- `main/game/send.mbt` - 14ä¸ªæ¶ˆæ¯API
- `main/game/test_send.mbt` - 8ä¸ªæµ‹è¯•å‡½æ•°
- `main/global_msg/global_msg.mbt` - æ¶ˆæ¯å¹¿æ’­

**å‰ç«¯**ï¼š
- `src/messageQueue.js` - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ14ä¸ªå¤„ç†å™¨ï¼‰
- `src/glue.js` - å‰åŽç«¯æ¡¥æŽ¥
- `src/vue/TestPanel.vue` - æµ‹è¯•é¢æ¿

---

## æ”¯æŒçš„æ¶ˆæ¯ç±»åž‹

### å•ä½æ“ä½œ
```moonbit
move_to(id, position)           // ç§»åŠ¨å•ä½
change_direction(id, direction) // æ”¹å˜æœå‘
remove_unit(id)                 // ç§»é™¤å•ä½ï¼ˆæ·¡å‡ºåŠ¨ç”»ï¼‰
set_copper(copper, id, pos)     // æ”¾ç½®é“œå¶
set_enemy(enemy, id, pos)       // æ”¾ç½®æ•Œäºº
```

### çŠ¶æ€æ˜¾ç¤º
```moonbit
display_can_move(id, true)      // æ˜¾ç¤ºç»¿åœˆ
display_can_attack(id, true)    // æ˜¾ç¤ºçº¢åœˆ
clear_state(id)                 // æ¸…é™¤çŠ¶æ€
```

### ç›¸æœºæŽ§åˆ¶
```moonbit
animate_move(id)                // èšç„¦åˆ°å•ä½
animate_reset()                 // å¤ä½è§†è§’
```

### åœ°å›¾å—
```moonbit
put_map_block(position)         // æ”¾ç½®åœ°å›¾å—
set_move_block(position)        // ç»¿è‰²å—
set_attack_block(position)      // çº¢è‰²å—
clear_block(position)           // æ¸…é™¤å—çŠ¶æ€
```

---

## åœ¨æ¸¸æˆä»£ç ä¸­ä½¿ç”¨

```moonbit
// åŽç«¯ MoonBit ä»£ç 
move_to(player_id, (5, 5))
display_can_move(player_id, true)
```

æ¶ˆæ¯ä¼š**è‡ªåŠ¨**é€šè¿‡ `global_msg` å‘é€åˆ°å‰ç«¯å¹¶æ‰§è¡ŒåŠ¨ç”»ã€‚

---

## é›†æˆåˆ°3Dåœºæ™¯

åœ¨ä½ çš„æ¸¸æˆåœºæ™¯ç»„ä»¶ä¸­ï¼š

```javascript
import { messageQueue, info_subscribe } from '@/glue.js'

onMounted(() => {
  // 1. è®¾ç½®åœºæ™¯ä¸Šä¸‹æ–‡
  messageQueue.setSceneContext({
    scene,           // Three.js Scene
    camera,          // Camera
    controls,        // OrbitControls
    models,          // [{id, object, ...}, ...]
    gridCellSize: 1.0,
    focusState: {},
  })
  
  // 2. è®¢é˜…æ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œç”¨äºŽæ—¥å¿—ï¼‰
  info_subscribe((msg) => {
    console.log('æ”¶åˆ°åŽç«¯æ¶ˆæ¯:', msg)
  })
})
```

**ç¡®ä¿æ¨¡åž‹æœ‰ID**ï¼š
```javascript
const model = {
  id: 1,  // ä¸ŽåŽç«¯IDå¯¹åº”
  object: gltfScene,
  // ...
}
```

---

## æ·»åŠ æ–°æ¶ˆæ¯ç±»åž‹

### 1. åŽç«¯å®šä¹‰API

```moonbit
// main/game/send.mbt
pub fn unit_jump(id : Int) -> Unit {
  @global_msg.msg_info.broadcast({
    type_msg: "unit_jump",
    content: ({ "id": id } : Json).stringify(),
  })
}
```

### 2. å‰ç«¯æ³¨å†Œå¤„ç†å™¨

```javascript
// src/messageQueue.js - registerAllHandlers()
messageQueue.registerHandler('unit_jump', async (data, context) => {
  const { id } = data
  const model = findModelById(context.models, id)
  
  if (model?.object) {
    // å®žçŽ°è·³è·ƒåŠ¨ç”»
    await jumpAnimation(model.object)
  }
})
```

### 3. å¯¼å‡ºæµ‹è¯•å‡½æ•°ï¼ˆå¯é€‰ï¼‰

```moonbit
// main/main/global.mbt
pub fn test_jump() -> Unit {
  @game.unit_jump(1)
}
```

