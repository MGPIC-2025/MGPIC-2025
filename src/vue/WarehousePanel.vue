<script setup>
import { ref } from 'vue'
import { getAssetUrl } from '../utils/resourceLoader.js'

// é“œå¶ä»“åº“ï¼šèµ„æºä¸é“œå¶æ•°æ®ï¼ˆå“åº”å¼ï¼‰
const resources = ref([
  { icon: getAssetUrl('img/warehouse/goods/2ec8cf838cb33e421005058d17ff555b82cebf83.webp'), name: 'è“æ™¶', value: 88 },
  { icon: getAssetUrl('img/warehouse/goods/04681f25cc1debaf94214a7e09f44efbc7eb2963.webp'), name: 'æœ¨ç®±', value: 88 },
  { icon: getAssetUrl('img/warehouse/goods/1331f319af1e23fc301b7253ca5dca71e9c19e0f.webp'), name: 'ç´«çƒ', value: 88 },
  { icon: getAssetUrl('img/warehouse/goods/ea74bce606c59ac4ab84ab117375c0de813cea49.webp'), name: 'è“ç‰‡', value: 88 }
])

// é“œå¶åˆ—è¡¨ï¼ˆå“åº”å¼ï¼‰
const puppets = ref([
  { 
    id: 1, 
    name: 'é˜¿ç£01', 
    level: 1, 
    image: getAssetUrl('img/warehouse/character/a93e15a01fcbf3cfb088956aedc63e86b94d4019.webp'), 
    quantity: 1,
    description: 'é˜¿ç£01æ˜¯çš‡å®«çš„å®ˆå«ï¼Œåœ¨"å¤§æ²‰ç¡"äº‹ä»¶ä¸­ï¼Œä»–åšå®ˆå²—ä½ï¼Œä¿æŠ¤ç€çš‡å®«çš„å®‰å…¨ã€‚ç°åœ¨ï¼Œä»–å°†ç»§ç»­å±¥è¡Œè‡ªå·±çš„èŒè´£ï¼Œå®ˆæŠ¤ç€è¿™ç‰‡åœŸåœ°ã€‚',
    stats: {
      level: '1/5',
      attack: { base: 10, bonus: 5 },
      defense: { base: 10, bonus: 5 },
      dodge: { base: 10, bonus: 2 },
      class: 'é“å£'
    },
    equipment: [
      { name: 'é’¢ç›¾', icon: getAssetUrl('img/warehouse/equip/3579e09f8cf4063c7d94f9f1d1a6db6fe746923f.webp'), equipped: true },
      { name: 'ç©ºæ§½', icon: 'ğŸ”’', equipped: false }
    ],
    skill: {
      name: 'é’¢ç›¾',
      cooldown: '10å›åˆ',
      effect: 'ä¿æŠ¤ç›¸é‚»8æ ¼çš„å•ä½2å›åˆä¸å—ä¼¤å®³(è‡ªå·±å¢åŠ å±æ€§50%çš„é˜²å¾¡åŠ›ä½†ä»ä¼šå—åˆ°ä¼¤å®³)',
      icon: getAssetUrl('img/warehouse/skill/9ae9fd092931138c37c47a30f463011e7f4301d8.webp')
    },
    upgradeCost: 10
  },
  { 
    id: 2, 
    name: 'å«æ–¯ç†01', 
    level: 1, 
    image: getAssetUrl('img/warehouse/character/b2207275b74545d9fae68b985b2998de3672e0af.webp'), 
    quantity: 1,
    description: 'å«æ–¯ç†01æœ€åˆæ˜¯çš‡å®«å¨æˆ¿çš„åŠ©æ‰‹ï¼Œåœ¨"å¤§æ²‰ç¡"äº‹ä»¶ä¸­ï¼Œä»–çš„é«˜æ€§èƒ½åˆé‡‘é”…å’Œå‡ºç°åœ¨å‰çº¿çš„åŸå› è‡³ä»Šä»æ˜¯ä¸ªè°œã€‚ç°åœ¨ï¼Œä»–å°†ç»§ç»­ä¸ºå›¢é˜Ÿæä¾›æ”¯æŒã€‚',
    stats: {
      level: '1/5',
      attack: { base: 10, bonus: 5 },
      defense: { base: 10, bonus: 5 },
      dodge: { base: 10, bonus: 2 },
      class: 'é“å£'
    },
    equipment: [
      { name: 'åˆé‡‘é”…', icon: getAssetUrl('img/warehouse/equip/3579e09f8cf4063c7d94f9f1d1a6db6fe746923f.webp'), equipped: true },
      { name: 'ç©ºæ§½', icon: 'ğŸ”’', equipped: false }
    ],
    skill: {
      name: 'é”…ç‚‰è¿‡çƒ­',
      cooldown: '10å›åˆ',
      effect: 'è‡ªå·±å—åˆ°æœ€å¤§ç”Ÿå‘½å€¼20%çš„ä¼¤å®³,å¯¹å‘¨å›´çš„æ•Œäººéƒ½é€ æˆæ— è§†é˜²å¾¡åŠ›ã€æ— æ³•è¢«é—ªé¿çš„ã€æ•°å€¼ä¸ºè‡ªå·±æœ€å¤§ç”Ÿå‘½å€¼15%çš„ä¼¤å®³ã€‚',
      icon: getAssetUrl('img/warehouse/skill/7b7cb41dbb1b9dae0bc4e7d030386f6d7d2e7da0.webp')
    },
    upgradeCost: 10
  }
])

const selectedPuppet = ref(null)
function selectPuppet(puppet) { selectedPuppet.value = puppet }

// æŠ½å¡ç•Œé¢å¼€å…³ï¼ˆå…¨å±ç•Œé¢ï¼‰
const showDrawScreen = ref(false)
function drawMore() { showDrawScreen.value = true }
function closeDrawScreen() { showDrawScreen.value = false }

// æŠ½å¡ç»“æœ
const drawResult = ref(null)
function closeDrawResult() { drawResult.value = null }

// æ‰£é™¤ç¬¬4ä¸ªèµ„æºï¼ˆè“ç‰‡ï¼‰10ç‚¹ï¼Œéšæœºè·å¾—ä¸€ä¸ªé“œå¶å¹¶+1æ•°é‡
function drawTen() {
  const costIndex = 3
  const store = resources.value
  if (!store[costIndex] || store[costIndex].value < 10) {
    alert('èµ„æºä¸è¶³')
    return
  }
  store[costIndex].value -= 10

  const list = puppets.value
  const idx = Math.floor(Math.random() * list.length)
  const got = list[idx]
  got.quantity = (got.quantity || 0) + 1
  selectedPuppet.value = got
  drawResult.value = { name: got.name, image: got.image }
}
</script>

<template>
  <div class="warehouse">
    <!-- é¡¶éƒ¨èµ„æºæ  -->
    <div class="warehouse__resources">
      <div class="resource-item" v-for="resource in resources" :key="resource.name">
        <div class="resource-icon">
          <img :src="resource.icon" :alt="resource.name" />
        </div>
        <div class="resource-value">{{ resource.value }}</div>
      </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºï¼ˆä¸¤ç§è§†å›¾ï¼šä»“åº“/æŠ½å¡ï¼‰ -->
    <div v-if="!showDrawScreen" class="warehouse__main">
      <!-- å·¦ä¾§é“œå¶åˆ—è¡¨ -->
      <div class="warehouse__sidebar">
        <div class="warehouse__title">é“œå¶ä»“åº“</div>
        <div class="puppet-list">
          <div class="puppet-card" v-for="puppet in puppets" :key="puppet.id" 
               :class="{ 'puppet-card--selected': selectedPuppet?.id === puppet.id }"
               @click="selectPuppet(puppet)">
            <div class="puppet-card__quantity">{{ puppet.quantity }}</div>
            <div class="puppet-card__image">
              <img :src="puppet.image" :alt="puppet.name" />
            </div>
            <div class="puppet-card__info">
              <div class="puppet-card__name">{{ puppet.name }}</div>
              <div class="puppet-card__level">{{ puppet.level }}çº§</div>
            </div>
          </div>
          
          <!-- æŠ½å–æ›´å¤šæŒ‰é’® -->
          <div class="puppet-card puppet-card--add" @click="drawMore">
            <div class="puppet-card__add-icon">+</div>
            <div class="puppet-card__add-text">æŠ½å–æ›´å¤š</div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
      <div class="warehouse__detail">
        <div v-if="selectedPuppet" class="puppet-detail">
          <div class="puppet-detail__header">
            <h2 class="puppet-detail__name">{{ selectedPuppet.name }}</h2>
          </div>
          
          <div class="puppet-detail__content">
            <!-- ç¬¬ä¸€è¡Œï¼šæ¨¡å‹å±•ç¤º + æè¿° -->
            <div class="puppet-detail__row">
              <!-- æ¨¡å‹å±•ç¤ºåŒºåŸŸ -->
              <div class="puppet-detail__model">
                <div class="model-placeholder">ä¸ºæ¨¡å‹å±•ç¤ºé¢„ç•™</div>
              </div>
              
              <!-- æè¿°åŒºåŸŸ -->
              <div class="puppet-detail__description">
                {{ selectedPuppet.description }}
              </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šå±æ€§ + è£…å¤‡ -->
            <div class="puppet-detail__row">
              <!-- å±æ€§é¢æ¿ -->
              <div class="puppet-detail__stats">
                <div class="stats-section">
                  <div class="stat-item">
                    <span class="stat-label">ç­‰çº§:</span>
                    <span class="stat-value">{{ selectedPuppet.stats.level }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">æ”»å‡»åŠ›:</span>
                    <span class="stat-value">{{ selectedPuppet.stats.attack.base }} <span class="stat-bonus">(+{{ selectedPuppet.stats.attack.bonus }})</span></span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">é˜²å¾¡åŠ›:</span>
                    <span class="stat-value">{{ selectedPuppet.stats.defense.base }} <span class="stat-bonus">(+{{ selectedPuppet.stats.defense.bonus }})</span></span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">é—ªé¿:</span>
                    <span class="stat-value">{{ selectedPuppet.stats.dodge.base }}% <span class="stat-bonus">(+{{ selectedPuppet.stats.dodge.bonus }}%)</span></span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">èŒä¸š:</span>
                    <span class="stat-value">{{ selectedPuppet.stats.class }}</span>
                  </div>
                </div>
              </div>
              
              <!-- è£…å¤‡åŒºåŸŸ -->
              <div class="equipment-section">
                <h4 class="section-title">è£…å¤‡</h4>
                <div class="equipment-slots">
                  <div v-for="(item, index) in selectedPuppet.equipment" :key="index" class="equipment-slot" :class="{ 'equipment-slot--empty': !item.equipped }">
                    <img v-if="item.equipped && item.icon.startsWith('/')" :src="item.icon" :alt="item.name" class="equipment-icon" />
                    <span v-else class="equipment-icon">{{ item.icon }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç¬¬ä¸‰è¡Œï¼šæŠ€èƒ½ -->
            <div class="skill-section">
              <h4 class="section-title">æŠ€èƒ½</h4>
              <div class="skill-info">
                <div class="skill-name">{{ selectedPuppet.skill.name }}</div>
                <div class="skill-cooldown">å†·å´: {{ selectedPuppet.skill.cooldown }}</div>
                <div class="skill-effect">{{ selectedPuppet.skill.effect }}</div>
                <div class="skill-icon">
                  <img v-if="selectedPuppet.skill.icon && selectedPuppet.skill.icon.startsWith('/')" :src="selectedPuppet.skill.icon" :alt="selectedPuppet.skill.name" class="skill-icon-img" />
                  <span v-else>{{ selectedPuppet.skill.icon }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- å‡çº§æŒ‰é’® -->
          <div class="puppet-detail__upgrade">
            <div class="upgrade-cost">
              <img class="cost-icon-img" :src="getAssetUrl('img/warehouse/goods/ea74bce606c59ac4ab84ab117375c0de813cea49.webp')" alt="cost" />
              <span class="cost-amount">X {{ selectedPuppet.upgradeCost }}</span>
            </div>
            <button class="upgrade-btn">
              <span class="upgrade-icon">â«</span>
            </button>
          </div>
        </div>
        <div v-else class="warehouse__placeholder">
          <p>è¯·é€‰æ‹©è‹±é›„ä»¥æµè§ˆ</p>
        </div>
      </div>
    </div>

    <!-- æŠ½å¡å…¨å±ç•Œé¢ï¼ˆä¿ç•™é¡¶éƒ¨èµ„æºæ ï¼‰ -->
    <div v-if="showDrawScreen" class="draw-screen">
      <div class="draw-screen__body">
        <div class="draw-card">
          <img class="draw-card__img" :src="getAssetUrl('img/warehouse/goods/04681f25cc1debaf94214a7e09f44efbc7eb2963.webp')" alt="card" />
        </div>
        <div class="draw-cost">
          <img class="draw-cost__icon" :src="getAssetUrl('img/warehouse/goods/ea74bce606c59ac4ab84ab117375c0de813cea49.webp')" alt="cost" />
          <span class="draw-cost__times">X 10</span>
        </div>
        <button class="draw-action" @click="drawTen">æŠ½å–å¡ç‰Œ</button>
      </div>
    </div>

  </div>

  <!-- æŠ½å¡ç»“æœæç¤º -->
  <div v-if="drawResult" class="draw-result" @click="closeDrawResult">
    <div class="draw-result__panel">
      <div class="draw-result__img-wrap">
        <img :src="drawResult.image" :alt="drawResult.name" />
      </div>
      <div class="draw-result__name">{{ drawResult.name }}</div>
      <div class="draw-result__hint">ç‚¹å‡»ä»»æ„ä½ç½®å…³é—­</div>
    </div>
  </div>
  
</template>

<style scoped>
/* Warehouse panel */
.warehouse { position: absolute; inset: 0; background: #a7a7a7; color: #fff; display: flex; flex-direction: column; }

/* é¡¶éƒ¨èµ„æºæ  */
.warehouse__resources { height: 80px; background: #a7a7a7; display: flex; align-items: center; gap: 32px; padding: 0 40px; margin-left: 120px; margin-top: 20px; }
.resource-item { display: flex; align-items: center; gap: 16px; background: #3a2519; padding: 16px 24px; border-radius: 12px; min-width: 160px; }
.resource-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
.resource-icon img { width: 130%; height: 130%; object-fit: contain; }
.resource-value { font-size: 24px; font-weight: 700; color: #fff; }

/* ä¸»å†…å®¹åŒº */
.warehouse__main { flex: 1; display: flex; margin-top: 20px; }

/* å·¦ä¾§é“œå¶åˆ—è¡¨ */
.warehouse__sidebar { width: 70%; background: #3a2519; padding: 20px; overflow-y: auto; }
.warehouse__title { font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #fff; }
.puppet-list { display: flex; flex-wrap: wrap; gap: 20px; }

.puppet-card { position: relative; background: #4b2e1f; border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.2s ease; width: 200px; height: 200px; display: flex; flex-direction: column; }
.puppet-card:hover { background: #5a3525; }
.puppet-card--selected { background: #6a3f2f; border: 2px solid #f59e0b; }
.puppet-card--add { background: #3a2519; border: 2px dashed #666; display: flex; flex-direction: column; align-items: center; justify-content: center; }

.puppet-card__quantity { position: absolute; top: 8px; left: 8px; width: 24px; height: 24px; background: #2b1a11; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #fff; }
.puppet-card__image { height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
.puppet-card__image img { max-width: 100%; max-height: 100%; object-fit: contain; }
.puppet-card__info { text-align: center; }
.puppet-card__name { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: #fff; }
.puppet-card__level { font-size: 14px; color: #ccc; }

.puppet-card__add-icon { font-size: 48px; color: #999; margin-bottom: 8px; }
.puppet-card__add-text { font-size: 16px; color: #999; }

/* å³ä¾§è¯¦æƒ…é¢æ¿ */
.warehouse__detail { width: 30%; background: #3a2519; margin: 20px; border-radius: 12px; display: flex; flex-direction: column; overflow-y: auto; max-height: calc(100vh - 140px); }
.warehouse__placeholder { text-align: center; color: #ccc; font-size: 18px; padding: 40px; }

.puppet-detail { padding: 20px; color: #fff; min-height: 100%; display: flex; flex-direction: column; }
.puppet-detail__header { margin-bottom: 20px; }
.puppet-detail__name { font-size: 28px; font-weight: 900; color: #fff; margin: 0; }

.puppet-detail__content { flex: 1; display: flex; flex-direction: column; gap: 20px; }
.puppet-detail__row { display: flex; gap: 20px; }
.puppet-detail__model { background: #4b2e1f; border-radius: 8px; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.model-placeholder { color: #999; font-size: 16px; }

.puppet-detail__description { flex: 1; color: #ccc; font-size: 14px; line-height: 1.6; }

.puppet-detail__stats { flex: 1; display: flex; flex-direction: column; gap: 8px; }
.stats-section { display: flex; flex-direction: column; gap: 8px; }
.stat-item { display: flex; justify-content: space-between; align-items: center; }
.stat-label { color: #ccc; font-size: 14px; }
.stat-value { color: #fff; font-weight: 600; }
.stat-bonus { color: #4ade80; font-size: 12px; }

.equipment-section { flex: 1; }
.section-title { color: #fff; font-size: 16px; font-weight: 700; margin-bottom: 12px; }
.equipment-slots { display: flex; gap: 8px; }
.equipment-slot { width: 40px; height: 40px; background: #4b2e1f; border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.equipment-slot--empty { background: #2b1a11; border: 1px solid #666; }
.equipment-icon { font-size: 20px; }
/* è®©è£…å¤‡å›¾ç‰‡ä¸¥æ ¼é™åˆ¶åœ¨æ§½ä½å†…ï¼Œé¿å…æº¢å‡º */
.equipment-slot img { width: 100%; height: 100%; object-fit: contain; display: block; }

.skill-info { background: #4b2e1f; padding: 12px; border-radius: 8px; }
.skill-name { color: #fff; font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.skill-cooldown { color: #ccc; font-size: 12px; margin-bottom: 8px; }
.skill-effect { color: #ccc; font-size: 12px; line-height: 1.4; margin-bottom: 8px; }
.skill-icon { font-size: 24px; text-align: right; }
.skill-icon-img { width: 48px; height: 48px; object-fit: contain; display: inline-block; }

.puppet-detail__upgrade { display: flex; align-items: center; justify-content: space-between; margin-top: auto; padding-top: 20px; }
.upgrade-cost { display: flex; align-items: center; gap: 8px; color: #fbbf24; font-weight: 600; }
.cost-icon { font-size: 18px; }
.cost-icon-img { width: 20px; height: 20px; object-fit: contain; display: inline-block; }
.upgrade-btn { width: 50px; height: 50px; background: #4b2e1f; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.upgrade-btn:hover { background: #5a3525; }
.upgrade-icon { font-size: 20px; color: #fff; }

/* æŠ½å¡å…¨å±ç•Œé¢ */
.draw-screen { position: relative; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 8px; }
.draw-screen__header { display: none; }
.draw-back { display: none; }
.draw-screen__body { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.draw-card { width: 520px; height: 520px; display: flex; align-items: center; justify-content: center; }
.draw-card__img { width: 100%; height: 100%; object-fit: contain; }
.draw-cost { display: flex; align-items: center; gap: 8px; }
.draw-cost__icon { width: 48px; height: 48px; object-fit: contain; }
.draw-cost__times { color: #fff; font-size: 22px; font-weight: 700; }
.draw-action { margin-top: 6px; background: #3a2519; color: #fff; border: none; border-radius: 16px; padding: 12px 44px; font-size: 26px; cursor: pointer; }
.draw-action:hover { background: #5a3525; }

/* æŠ½å¡ç»“æœ */
.draw-result { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 1100; }
.draw-result__panel { background: #3a2519; color: #fff; padding: 20px 28px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
.draw-result__img-wrap { width: 200px; height: 200px; margin: 0 auto 12px; }
.draw-result__img-wrap img { width: 100%; height: 100%; object-fit: contain; }
.draw-result__name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.draw-result__hint { color: #ccc; font-size: 12px; }
</style>
